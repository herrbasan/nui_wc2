<header>
	<h1>Animation</h1>
	<p>A thin wrapper around the Web Animations API with shorthand properties and easing presets</p>
</header>

<section>
	<h2>Overview</h2>
	<p>The <code>nui.animate()</code> function wraps the native Web Animations API, adding convenience features while maintaining direct platform access. Every element also gets an <code>.ani()</code> method for fluent chaining.</p>
	
	<nui-code>
		<script type="example" data-lang="js">
// Two equivalent ways to animate
element.ani(duration, properties, options);
nui.animate(element, duration, properties, options);

// Returns animation controller with play/pause/cancel
const ani = element.ani(1000, { x: 200 });
ani.pause();
ani.play();
		</script>
	</nui-code>
</section>

<section>
	<h2>Transform Shorthands</h2>
	<p>Common transforms use intuitive shorthand names with automatic unit handling:</p>
	
	<div class="demo-grid">
		<div class="demo-card">
			<div class="demo-label"><code>x</code> / <code>y</code></div>
			<div class="demo-stage"><nui-icon name="arrow" class="anim-icon" id="demo-xy"></nui-icon></div>
			<nui-button><button type="button" data-action="anim-transform:xy">Translate</button></nui-button>
		</div>
		<div class="demo-card">
			<div class="demo-label"><code>scale</code></div>
			<div class="demo-stage"><nui-icon name="fullscreen" class="anim-icon" id="demo-scale"></nui-icon></div>
			<nui-button><button type="button" data-action="anim-transform:scale">Scale</button></nui-button>
		</div>
		<div class="demo-card">
			<div class="demo-label"><code>rotate</code></div>
			<div class="demo-stage"><nui-icon name="settings" class="anim-icon" id="demo-rotate"></nui-icon></div>
			<nui-button><button type="button" data-action="anim-transform:rotate">Rotate</button></nui-button>
		</div>
		<div class="demo-card">
			<div class="demo-label">Combined</div>
			<div class="demo-stage"><nui-icon name="star_rate" class="anim-icon" id="demo-combined"></nui-icon></div>
			<nui-button><button type="button" data-action="anim-transform:combined">All</button></nui-button>
		</div>
	</div>

	<nui-code>
		<script type="example" data-lang="js">
// Shorthand → CSS transform
{ x: 100 }      → translateX(100px)
{ y: 50 }       → translateY(50px)
{ scale: 1.5 }  → scale(1.5)
{ rotate: 45 }  → rotate(45deg)

// Combine multiple transforms
element.ani(800, { x: 100, y: 50, scale: 1.2, rotate: 15 });
		</script>
	</nui-code>
</section>

<section>
	<h2>Easing Presets</h2>
	<p>Named easing functions using dot notation. Each preset has <code>.in</code>, <code>.out</code>, and <code>.inOut</code> variants:</p>
	
	<div class="easing-comparison" id="easing-demo">
		<div class="easing-row"><span class="easing-name">linear</span><div class="easing-track"><div class="easing-dot" data-ease="linear"></div></div></div>
		<div class="easing-row"><span class="easing-name">sine.out</span><div class="easing-track"><div class="easing-dot" data-ease="sine.out"></div></div></div>
		<div class="easing-row"><span class="easing-name">quad.out</span><div class="easing-track"><div class="easing-dot" data-ease="quad.out"></div></div></div>
		<div class="easing-row"><span class="easing-name">cubic.out</span><div class="easing-track"><div class="easing-dot" data-ease="cubic.out"></div></div></div>
		<div class="easing-row"><span class="easing-name">quart.out</span><div class="easing-track"><div class="easing-dot" data-ease="quart.out"></div></div></div>
		<div class="easing-row"><span class="easing-name">expo.out</span><div class="easing-track"><div class="easing-dot" data-ease="expo.out"></div></div></div>
		<div class="easing-row"><span class="easing-name">back.out</span><div class="easing-track"><div class="easing-dot" data-ease="back.out"></div></div></div>
	</div>
	<nui-button-container align="center">
		<nui-button><button type="button" data-action="anim-easing">Compare Easing</button></nui-button>
	</nui-button-container>

	<nui-code>
		<script type="example" data-lang="js">
// Available presets: sine, quad, cubic, quart, quint, expo, circ, back
// Each has: .in (slow start), .out (slow end), .inOut (slow both)

element.ani(600, { x: 200, ease: 'expo.out' });
element.ani(400, { scale: 1.2, ease: 'back.out' });
		</script>
	</nui-code>
</section>

<section>
	<h2>Keyframe Sequences</h2>
	<p>Pass an array of keyframes for multi-step animations. Use <code>offset</code> to control timing:</p>
	
	<div class="demo-stage-wide">
		<nui-icon name="public" class="anim-icon" id="demo-keyframes"></nui-icon>
	</div>
	<nui-button-container align="center">
		<nui-button><button type="button" data-action="anim-keyframes">Play Sequence</button></nui-button>
	</nui-button-container>

	<nui-code>
		<script type="example" data-lang="js">
element.ani(2000, [
	{ x: 0, scale: 1, rotate: 0 },
	{ x: 150, scale: 1.3, rotate: 0, offset: 0.3 },
	{ x: 150, scale: 1.3, rotate: 180, offset: 0.6 },
	{ x: 300, scale: 1, rotate: 360 }
], { ease: 'cubic.inOut' });
		</script>
	</nui-code>
</section>

<section>
	<h2>Animation Options</h2>
	<p>Control timing, repetition, and direction through the options object:</p>
	
	<div class="options-demo">
		<div class="option-row">
			<div class="option-label">
				<strong>delay / endDelay</strong>
				<span>Wait before/after animation</span>
			</div>
			<div class="demo-stage"><nui-icon name="calendar" class="anim-icon" id="demo-delay"></nui-icon></div>
			<nui-button><button type="button" data-action="anim-option:delay">Play</button></nui-button>
		</div>
		<div class="option-row">
			<div class="option-label">
				<strong>iterations</strong>
				<span>Repeat count (Infinity for loop)</span>
			</div>
			<div class="demo-stage"><nui-icon name="sync" class="anim-icon" id="demo-iterations"></nui-icon></div>
			<nui-button><button type="button" data-action="anim-option:iterations">Play 3×</button></nui-button>
		</div>
		<div class="option-row">
			<div class="option-label">
				<strong>direction: alternate</strong>
				<span>Reverse on repeat</span>
			</div>
			<div class="demo-stage"><nui-icon name="sort" class="anim-icon" id="demo-alternate"></nui-icon></div>
			<nui-button><button type="button" data-action="anim-option:alternate">Bounce</button></nui-button>
		</div>
	</div>

	<nui-code>
		<script type="example" data-lang="js">
// Delay start and end
element.ani(500, { x: 200 }, { delay: 300, endDelay: 200 });

// Repeat 3 times
element.ani(400, { rotate: 360 }, { iterations: 3 });

// Bounce back and forth
element.ani(600, { x: 200 }, { iterations: 4, direction: 'alternate' });

// Loop forever
element.ani(1000, { rotate: 360 }, { iterations: Infinity });
		</script>
	</nui-code>
</section>

<section>
	<h2>Playback Control</h2>
	<p>The animation controller provides methods to pause, resume, cancel, and seek:</p>
	
	<div class="control-demo">
		<div class="demo-stage-wide">
			<nui-icon name="person" class="anim-icon" id="demo-control"></nui-icon>
		</div>
		<div class="control-info">
			<span>Time: <strong id="control-time">0</strong>ms</span>
			<span>Progress: <strong id="control-progress">0%</strong></span>
			<span>State: <strong id="control-state">idle</strong></span>
		</div>
		<nui-button-container align="center">
			<nui-button><button type="button" data-action="anim-control:play">Play</button></nui-button>
			<nui-button variant="outline"><button type="button" data-action="anim-control:pause">Pause</button></nui-button>
			<nui-button variant="outline"><button type="button" data-action="anim-control:cancel">Cancel</button></nui-button>
		</nui-button-container>
	</div>

	<nui-code>
		<script type="example" data-lang="js">
const ani = element.ani(3000, { x: 400 }, {
	paused: true,  // Don't auto-start
	update: (a) => {
		console.log(a.currentTime, a.progress);
	}
});

ani.play();          // Start/resume
ani.pause();         // Pause
ani.cancel();        // Stop and reset
ani.play(1500);      // Seek to 1500ms and play
		</script>
	</nui-code>
</section>

<section>
	<h2>Callbacks & Events</h2>
	<p>React to animation lifecycle with callbacks and the events handler:</p>
	
	<div class="events-demo">
		<div class="demo-stage-wide">
			<nui-icon name="notifications" class="anim-icon" id="demo-events"></nui-icon>
		</div>
		<div class="event-log" id="event-log">Events will appear here...</div>
		<nui-button-container align="center">
			<nui-button><button type="button" data-action="anim-events">Play with Events</button></nui-button>
		</nui-button-container>
	</div>

	<nui-code>
		<script type="example" data-lang="js">
element.ani(1500, [
	{ x: 0, scale: 1 },
	{ x: 150, scale: 1.5, offset: 0.5 },
	{ x: 300, scale: 1 }
], {
	events: (e) => {
		// e.type: 'start', 'running', 'keyframe', 'finished', etc.
		console.log(e.type, e.idx);  // keyframe index when type='keyframe'
	},
	cb: (ani) => {
		// Called when animation completes
		console.log('Done!', ani.progress);
	}
});
		</script>
	</nui-code>
</section>

<section>
	<h2>Chaining Animations</h2>
	<p>Use the <code>cb</code> callback to sequence animations:</p>
	
	<div class="demo-stage-wide">
		<nui-icon name="stadia_controller" class="anim-icon" id="demo-chain"></nui-icon>
	</div>
	<nui-button-container align="center">
		<nui-button><button type="button" data-action="anim-chain">Run Sequence</button></nui-button>
	</nui-button-container>

	<nui-code>
		<script type="example" data-lang="js">
// Chain with callbacks
box.ani(300, { scale: 1.4, ease: 'back.out' }, {
	cb: () => box.ani(400, { rotate: 180, ease: 'expo.out' }, {
		cb: () => box.ani(300, { scale: 1, ease: 'back.out' }, {
			cb: () => box.ani(400, { rotate: 360, x: 200, ease: 'expo.out' })
		})
	})
});
		</script>
	</nui-code>
</section>

<section>
	<h2>Practical Example: Button Feedback</h2>
	<p>Micro-animations provide tactile feedback for user interactions:</p>
	
	<div class="practical-demo">
		<nui-button><button type="button" class="feedback-btn" data-action="anim-practical:success">Success</button></nui-button>
		<nui-button><button type="button" class="feedback-btn" data-action="anim-practical:error">Error</button></nui-button>
		<nui-button><button type="button" class="feedback-btn" data-action="anim-practical:loading">Submit</button></nui-button>
	</div>

	<nui-code>
		<script type="example" data-lang="js">
// Success pulse
btn.ani(150, { scale: 0.95 }, {
	cb: () => btn.ani(300, { scale: 1, ease: 'back.out' })
});

// Error shake
btn.ani(80, [
	{ x: 0 }, { x: -8 }, { x: 8 }, { x: -8 }, { x: 8 }, { x: 0 }
]);

// Loading state with infinite rotation
const spinner = btn.ani(800, { rotate: 360 }, { iterations: Infinity });
// Later: spinner.cancel();
		</script>
	</nui-code>
</section>

<style>
.demo-grid {
	display: grid;
	grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
	gap: var(--nui-space);
	margin: var(--nui-space) 0;
}

.demo-card {
	background: var(--nui-surface);
	border-radius: var(--nui-radius);
	padding: var(--nui-space);
	text-align: center;
}

.demo-label {
	margin-bottom: var(--nui-space-half);
	font-size: 0.875rem;
}

.demo-stage {
	height: 80px;
	display: flex;
	align-items: center;
	justify-content: flex-start;
	padding: 0 var(--nui-space);
	background: var(--nui-surface-dim);
	border-radius: var(--nui-radius-small);
	margin-bottom: var(--nui-space-half);
	overflow: hidden;
}

.demo-stage-wide {
	height: 100px;
	display: flex;
	align-items: center;
	padding: 0 var(--nui-space-double);
	background: var(--nui-surface-dim);
	border-radius: var(--nui-radius);
	margin: var(--nui-space) 0;
	overflow: hidden;
}

.anim-icon {
	font-size: 2.5rem;
	color: var(--nui-accent, #3b82f6);
	flex-shrink: 0;
}

.easing-comparison {
	background: var(--nui-surface-dim);
	border-radius: var(--nui-radius);
	padding: var(--nui-space);
	margin: var(--nui-space) 0;
}

.easing-row {
	display: flex;
	align-items: center;
	gap: var(--nui-space);
	padding: 0.4rem 0;
}

.easing-name {
	width: 80px;
	font-size: 0.75rem;
	font-family: var(--nui-font-mono);
	color: var(--nui-text-dim);
}

.easing-track {
	flex: 1;
	height: 20px;
	background: var(--nui-surface);
	border-radius: 10px;
	position: relative;
	overflow: hidden;
}

.easing-dot {
	width: 16px;
	height: 16px;
	background: var(--nui-accent, #3b82f6);
	border-radius: 50%;
	position: absolute;
	top: 2px;
	left: 2px;
}

.options-demo {
	display: flex;
	flex-direction: column;
	gap: var(--nui-space);
	margin: var(--nui-space) 0;
}

.option-row {
	display: grid;
	grid-template-columns: 200px 1fr auto;
	gap: var(--nui-space);
	align-items: center;
	background: var(--nui-surface-dim);
	padding: var(--nui-space);
	border-radius: var(--nui-radius);
}

.option-label {
	display: flex;
	flex-direction: column;
}

.option-label span {
	font-size: 0.75rem;
	color: var(--nui-text-dim);
}

.control-demo {
	background: var(--nui-surface-dim);
	border-radius: var(--nui-radius);
	padding: var(--nui-space);
	margin: var(--nui-space) 0;
}

.control-info {
	display: flex;
	justify-content: center;
	gap: var(--nui-space-double);
	margin-bottom: var(--nui-space);
	font-size: 0.875rem;
}

.control-info strong {
	font-family: var(--nui-font-mono);
	color: var(--nui-accent);
}

.events-demo {
	background: var(--nui-surface-dim);
	border-radius: var(--nui-radius);
	padding: var(--nui-space);
	margin: var(--nui-space) 0;
}

.event-log {
	font-family: var(--nui-font-mono);
	font-size: 0.75rem;
	background: var(--nui-surface);
	padding: var(--nui-space);
	border-radius: var(--nui-radius-small);
	margin-bottom: var(--nui-space);
	height: 60px;
	overflow-y: auto;
	color: var(--nui-text-dim);
}

.practical-demo {
	display: flex;
	gap: var(--nui-space);
	justify-content: center;
	margin: var(--nui-space-double) 0;
}

.feedback-btn {
	min-width: 100px;
}

@media (max-width: 600px) {
	.option-row {
		grid-template-columns: 1fr;
	}
	
	.control-info {
		flex-direction: column;
		align-items: center;
		gap: var(--nui-space-half);
	}
}
</style>

<script type="nui/page">
function init(element, params) {
	
	// Helper to reset transform
	function reset(el) {
		el.style.transform = '';
		el.style.opacity = '';
	}

	// Element References
	const xyBox = element.querySelector('#demo-xy');
	const scaleBox = element.querySelector('#demo-scale');
	const rotateBox = element.querySelector('#demo-rotate');
	const combinedBox = element.querySelector('#demo-combined');
	const easingDots = element.querySelectorAll('.easing-dot');
	const keyframesBox = element.querySelector('#demo-keyframes');
	const delayBox = element.querySelector('#demo-delay');
	const iterBox = element.querySelector('#demo-iterations');
	const altBox = element.querySelector('#demo-alternate');
	const controlBox = element.querySelector('#demo-control');
	const timeEl = element.querySelector('#control-time');
	const progressEl = element.querySelector('#control-progress');
	const stateEl = element.querySelector('#control-state');
	const eventsBox = element.querySelector('#demo-events');
	const eventLog = element.querySelector('#event-log');
	const chainBox = element.querySelector('#demo-chain');

	// State
	const easingAnimations = new Map();
	let controlAni = null;
	let loadingAni = null;

	// Control Animation Setup
	function createControlAnimation() {
		reset(controlBox);
		controlAni = controlBox.ani(3000, { x: 450 }, {
			paused: true,
			ease: 'sine.inOut',
			update: (a) => {
				timeEl.textContent = Math.round(a.currentTime);
				progressEl.textContent = Math.round(a.progress * 100) + '%';
			},
			events: (e) => {
				if (['running', 'paused', 'finished', 'idle'].includes(e.type)) {
					stateEl.textContent = e.type;
				}
			}
		});
	}
	createControlAnimation();

	// Event Logging Helper
	function log(msg) {
		const time = new Date().toLocaleTimeString('en', { hour12: false });
		eventLog.innerHTML = `<div>${time} — ${msg}</div>` + eventLog.innerHTML;
	}

	// Main Action Handler
	element.addEventListener('nui-action', (e) => {
		const { name, target, param } = e.detail;

		switch(name) {
			// Transform Shorthands
			case 'anim-transform':
				if (param === 'xy') {
					reset(xyBox);
					xyBox.ani(600, { x: 120, y: 20, ease: 'quad.out' }, {
						cb: () => xyBox.ani(600, { x: 0, y: 0, ease: 'quad.inOut' })
					});
				} else if (param === 'scale') {
					reset(scaleBox);
					scaleBox.ani(400, { scale: 1.6, ease: 'back.out' }, {
						cb: () => scaleBox.ani(300, { scale: 1, ease: 'quad.out' })
					});
				} else if (param === 'rotate') {
					reset(rotateBox);
					rotateBox.ani(800, { rotate: 360, ease: 'expo.out' });
				} else if (param === 'combined') {
					reset(combinedBox);
					combinedBox.ani(800, { x: 80, scale: 1.3, rotate: 180, ease: 'cubic.out' }, {
						cb: () => combinedBox.ani(600, { x: 0, scale: 1, rotate: 360, ease: 'cubic.inOut' })
					});
				}
				break;

			// Easing Comparison
			case 'anim-easing':
				easingDots.forEach(dot => {
					if (easingAnimations.has(dot)) {
						easingAnimations.get(dot).cancel();
					}
					dot.style.left = '2px';
					const ease = dot.dataset.ease;
					const trackWidth = dot.parentElement.offsetWidth;
					const endPos = trackWidth - 18;
					const ani = dot.ani(1200, { left: endPos }, { 
						ease: ease === 'linear' ? undefined : ease 
					});
					easingAnimations.set(dot, ani);
				});
				break;

			// Keyframes
			case 'anim-keyframes':
				reset(keyframesBox);
				keyframesBox.ani(2000, [
					{ x: 0, scale: 1, rotate: 0 },
					{ x: 150, scale: 1.3, rotate: 0, offset: 0.3 },
					{ x: 150, scale: 1.3, rotate: 180, offset: 0.6 },
					{ x: 350, scale: 1, rotate: 360 }
				], { ease: 'cubic.inOut' });
				break;

			// Options
			case 'anim-option':
				if (param === 'delay') {
					reset(delayBox);
					delayBox.style.opacity = '0.4';
					delayBox.ani(400, { x: 150, opacity: 1 }, { 
						delay: 500, 
						endDelay: 300,
						ease: 'expo.out',
						cb: () => {
							delayBox.ani(400, { x: 0, opacity: 0.4 }, { ease: 'expo.in' });
						}
					});
				} else if (param === 'iterations') {
					reset(iterBox);
					iterBox.ani(300, { rotate: 360 }, { iterations: 3, ease: 'sine.inOut' });
				} else if (param === 'alternate') {
					reset(altBox);
					altBox.ani(400, { x: 150 }, { 
						iterations: 4, 
						direction: 'alternate',
						ease: 'quad.inOut'
					});
				}
				break;

			// Playback Control
			case 'anim-control':
				if (param === 'play') {
					if (!controlAni || controlAni.animation.playState === 'finished') {
						createControlAnimation();
					}
					controlAni.play();
				} else if (param === 'pause') {
					if (controlAni) controlAni.pause();
				} else if (param === 'cancel') {
					if (controlAni) controlAni.cancel();
					timeEl.textContent = '0';
					progressEl.textContent = '0%';
					stateEl.textContent = 'idle';
					createControlAnimation();
				}
				break;

			// Events
			case 'anim-events':
				reset(eventsBox);
				eventLog.innerHTML = '';
				log('Animation started');
				
				eventsBox.ani(1500, [
					{ x: 0, scale: 1 },
					{ x: 150, scale: 1.5, offset: 0.5 },
					{ x: 350, scale: 1 }
				], {
					ease: 'cubic.inOut',
					events: (e) => {
						if (e.type === 'keyframe') {
							log(`Keyframe ${e.idx} reached`);
						} else if (e.type === 'finished') {
							log('Animation finished');
						}
					},
					cb: (ani) => {
						log(`Callback fired (progress: ${Math.round(ani.progress * 100)}%)`);
					}
				});
				break;

			// Chain
			case 'anim-chain':
				reset(chainBox);
				chainBox.ani(300, { scale: 1.4, ease: 'back.out' }, {
					cb: () => chainBox.ani(400, { rotate: 180, ease: 'expo.out' }, {
						cb: () => chainBox.ani(300, { scale: 1, ease: 'back.out' }, {
							cb: () => chainBox.ani(500, { x: 350, rotate: 360, ease: 'expo.out' }, {
								cb: () => chainBox.ani(400, { x: 0, scale: 1, ease: 'cubic.inOut' })
							})
						})
					})
				});
				break;

			// Practical Examples
			case 'anim-practical':
				const btn = target.closest('button'); // Ensure we have the button
				if (param === 'success') {
					btn.ani(100, { scale: 0.92 }, {
						cb: () => btn.ani(300, { scale: 1, ease: 'back.out' })
					});
				} else if (param === 'error') {
					btn.ani(400, [
						{ x: 0 }, { x: -6 }, { x: 6 }, { x: -6 }, { x: 6 }, { x: -4 }, { x: 4 }, { x: 0 }
					]);
				} else if (param === 'loading') {
					if (loadingAni) {
						loadingAni.cancel();
						loadingAni = null;
						btn.textContent = 'Submit';
						btn.style.transform = '';
						return;
					}
					
					btn.textContent = '⟳';
					loadingAni = btn.ani(800, { rotate: 360 }, { iterations: Infinity });
					
					// Auto-stop after 3 seconds for demo
					setTimeout(() => {
						if (loadingAni) {
							loadingAni.cancel();
							loadingAni = null;
							btn.textContent = 'Submit';
							btn.style.transform = '';
						}
					}, 3000);
				}
				break;
		}
	});

	// Cleanup
	element.hide = () => {
		if (loadingAni) {
			loadingAni.cancel();
			loadingAni = null;
		}
		if (controlAni) {
			controlAni.cancel();
			controlAni = null;
		}
	};
}
</script>
