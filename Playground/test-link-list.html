<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>NUI Link List - Active State Test</title>
	<script type="module" src="../NUI/nui.js"></script>
	<link rel="stylesheet" href="../NUI/css/nui-theme-slate.css">
	<style>
		body {
			margin: 0;
			font-family: system-ui, -apple-system, sans-serif;
		}
		
		.test-controls {
			position: fixed;
			top: 1rem;
			right: 1rem;
			background: var(--nui-surface-1);
			padding: 1rem;
			border-radius: 0.5rem;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
			z-index: 1000;
			max-width: 300px;
		}
		
		.test-controls h3 {
			margin: 0 0 1rem 0;
			font-size: 1rem;
		}
		
		.test-controls button {
			display: block;
			width: 100%;
			margin-bottom: 0.5rem;
			padding: 0.5rem;
			background: var(--nui-primary);
			color: white;
			border: none;
			border-radius: 0.25rem;
			cursor: pointer;
		}
		
		.test-controls button:hover {
			background: var(--nui-primary-hover);
		}
		
		.test-controls .state-display {
			margin-top: 1rem;
			padding: 0.5rem;
			background: var(--nui-surface-2);
			border-radius: 0.25rem;
			font-size: 0.875rem;
			font-family: monospace;
			white-space: pre-wrap;
			word-break: break-all;
		}
		
		.test-controls .state-display strong {
			display: block;
			margin-bottom: 0.5rem;
			font-family: system-ui;
		}
	</style>
</head>
<body>
	<nui-app nui-vars-sidebar_width="15rem" nui-vars-sidebar_force-breakpoint="60rem">
		<nui-top-nav>
			<header>
				<layout>
					<item>
						<h1>Link List Active State Test</h1>
					</item>
					<item>
						<nui-button>
							<button type="button" nui-event-click="toggle@nui-app" aria-label="Toggle Sidebar">
								<nui-icon name="menu"></nui-icon>
							</button>
						</nui-button>
					</item>
				</layout>
			</header>
		</nui-top-nav>

		<nui-side-nav>
			<nui-link-list mode="fold">
				<ul>
					<li class="group-header">
						<span>
							<nui-icon name="dashboard"></nui-icon>
							<span>Dashboard</span>
						</span>
					</li>
					<li><a href="#overview" data-test-id="overview">Overview</a></li>
					<li><a href="#analytics" data-test-id="analytics">Analytics</a></li>
					<li><a href="#reports" data-test-id="reports">Reports</a></li>
				</ul>
				
				<ul>
					<li class="group-header">
						<span>
							<nui-icon name="settings"></nui-icon>
							<span>Settings</span>
						</span>
					</li>
					<li><a href="#general" data-test-id="general">General</a></li>
					<li><a href="#security" data-test-id="security">Security</a></li>
					
					<ul>
						<li class="group-header">
							<span>
								<nui-icon name="account_circle"></nui-icon>
								<span>Account</span>
							</span>
						</li>
						<li><a href="#profile" data-test-id="profile">Profile</a></li>
						<li><a href="#preferences" data-test-id="preferences">Preferences</a></li>
						<li><a href="#notifications" data-test-id="notifications">Notifications</a></li>
					</ul>
				</ul>
				
				<ul>
					<li class="group-header">
						<span>
							<nui-icon name="help"></nui-icon>
							<span>Help</span>
						</span>
					</li>
					<li><a href="#documentation" data-test-id="documentation">Documentation</a></li>
					<li><a href="#support" data-test-id="support">Support</a></li>
				</ul>
			</nui-link-list>
		</nui-side-nav>

		<nui-content>
			<main>
				<h2>Link List Active State API Test</h2>
				
				<section style="max-width: 800px;">
					<p>This page tests the complete link-list active state management when used in side-nav:</p>
					
					<h3>Features Tested:</h3>
					<ul>
						<li><strong>setActive(selector)</strong> - Set active item by selector or element reference</li>
						<li><strong>getActive()</strong> - Get current active element</li>
						<li><strong>getActiveData()</strong> - Get active item data (element, href, text)</li>
						<li><strong>clearActive()</strong> - Clear active state</li>
						<li><strong>Auto-expand</strong> - Automatically opens parent groups when setting active</li>
						<li><strong>Knower integration</strong> - State changes notify Knower system</li>
						<li><strong>Memory cleanup</strong> - Proper cleanup on disconnect</li>
					</ul>
					
					<h3>Usage:</h3>
					<p>Use the control panel on the right to test different scenarios:</p>
					<ol>
						<li>Set active items at different nesting levels</li>
						<li>Watch groups auto-expand to reveal active items</li>
						<li>Get current active state programmatically</li>
						<li>Clear active state</li>
						<li>Monitor state changes via Knower</li>
					</ol>
					
					<h3>Click Links Directly:</h3>
					<p>You can also click any link in the sidebar. The click handler will:</p>
					<ul>
						<li>Set that link as active</li>
						<li>Update the state display</li>
						<li>Show the href in the browser console</li>
					</ul>
				</section>
			</main>
		</nui-content>
	</nui-app>

	<div class="test-controls">
		<h3>Test Controls</h3>
		<button id="setOverview">Set Active: Overview</button>
		<button id="setSecurity">Set Active: Security</button>
		<button id="setProfile">Set Active: Profile (nested)</button>
		<button id="setNotifications">Set Active: Notifications (deep nested)</button>
		<button id="getActive">Get Active State</button>
		<button id="clearActive">Clear Active</button>
		<button id="watchState">Watch State Changes</button>
		
		<div class="state-display" id="stateDisplay">
			<strong>State:</strong>
			No active item
		</div>
	</div>

	<script type="module">
		import { nui } from '../NUI/nui.js';
		
		const sideNav = document.querySelector('nui-side-nav');
		const linkList = document.querySelector('nui-link-list');
		const stateDisplay = document.getElementById('stateDisplay');
		
		function updateStateDisplay() {
			const data = sideNav.getActiveData();
			if (data) {
				stateDisplay.innerHTML = `<strong>Active State:</strong>
href: ${data.href}
text: ${data.text}
element: <li>
link: <a>`;
			} else {
				stateDisplay.innerHTML = '<strong>State:</strong>\nNo active item';
			}
		}
		
		// Test buttons
		document.getElementById('setOverview').onclick = () => {
			const result = sideNav.setActive('[data-test-id="overview"]');
			console.log('setActive result:', result);
			updateStateDisplay();
		};
		
		document.getElementById('setSecurity').onclick = () => {
			sideNav.setActive('[data-test-id="security"]');
			updateStateDisplay();
		};
		
		document.getElementById('setProfile').onclick = () => {
			sideNav.setActive('[data-test-id="profile"]');
			updateStateDisplay();
		};
		
		document.getElementById('setNotifications').onclick = () => {
			sideNav.setActive('[data-test-id="notifications"]');
			updateStateDisplay();
		};
		
		document.getElementById('getActive').onclick = () => {
			const active = sideNav.getActive();
			const data = sideNav.getActiveData();
			console.log('Active element:', active);
			console.log('Active data:', data);
			alert(`Active: ${data ? data.text : 'none'}\nHref: ${data ? data.href : 'none'}`);
		};
		
		document.getElementById('clearActive').onclick = () => {
			sideNav.clearActive();
			updateStateDisplay();
		};
		
		let watcherId = null;
		document.getElementById('watchState').onclick = () => {
			if (watcherId) {
				console.log('Already watching state changes. Check console for updates.');
				return;
			}
			
			const instanceId = linkList.getAttribute('nui-id');
			const stateKey = `${instanceId}:active`;
			
			watcherId = nui.knower.watch(stateKey, (state, oldState) => {
				console.log('[WATCHER] Active state changed:', {
					old: oldState,
					new: state
				});
			});
			
			alert('Now watching state changes. Open console to see updates.');
		};
		
		// Click handler for links
		linkList.addEventListener('click', (e) => {
			const link = e.target.closest('a');
			if (link) {
				e.preventDefault();
				sideNav.setActive(link);
				updateStateDisplay();
				console.log('Link clicked:', link.getAttribute('href'));
			}
		});
		
		// Initial state
		setTimeout(() => {
			sideNav.setActive('[data-test-id="overview"]');
			updateStateDisplay();
		}, 100);
	</script>
</body>
</html>
