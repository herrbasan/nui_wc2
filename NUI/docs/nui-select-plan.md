# NUI Select Component â€” Development Plan (Accessible)

## Goal
Implement a `nui-select` component that looks/feels similar to the legacy `superSelect` (from `reference/nui/nui_select.js` + `reference/nui/css/nui_select.css`), but built for the current NUI architecture and with accessibility as a first-class requirement.

Primary requirements:
- Single select and multi-select (`<select multiple>`)
- Optional search/filter UI
- Option groups (`<optgroup>`)
- Multi-select tags UI (remove selected)
- Full keyboard support (Up/Down, Enter, Escape, Tab)
- Close on outside click
- "Open upwards" behavior near bottom of viewport
- Progressive enhancement: native `<select>` works without JS
- **Rock-solid accessibility** â€” screen reader and keyboard-only users must have full control

---

## Architecture: Component Split

The multi-select UI requires tag management (add/remove chips). This functionality is useful independently (filter UIs, keyword inputs), so we split it into a **separate reusable component**.

### Component Hierarchy
```
nui-tag-input          (standalone, reusable)
â”œâ”€â”€ Manages array of {value, label} items
â”œâ”€â”€ Renders removable tag chips
â”œâ”€â”€ Form-compatible via hidden <input> elements
â”œâ”€â”€ Programmatic API: addTag(), removeTag(), listTags(), clear()
â””â”€â”€ Emits nui-tag-add, nui-tag-remove, nui-change events

nui-select             (composes nui-tag-input for multi-select)
â”œâ”€â”€ Wraps native <select>
â”œâ”€â”€ Control shows preview (FIXED SIZE - never expands)
â”‚   â”œâ”€â”€ Tag chips with overflow:hidden + gradient fade
â”‚   â””â”€â”€ Count badge: "5" near dropdown arrow
â”œâ”€â”€ Popup contains (when open):
â”‚   â”œâ”€â”€ Full tag list (editable, remove via Ã—)
â”‚   â”œâ”€â”€ Search input (if searchable)
â”‚   â””â”€â”€ Options list (checkboxes for multi)
â””â”€â”€ Two-way sync: tag removal â†” option deselection
```

### Key Design Decisions

1. **Fixed-size control**: The select control NEVER changes dimensions based on selection count. This prevents layout shifts.

2. **Preview pattern**: Closed state shows tag chips with `overflow: hidden`, gradient fade on right edge, and a count badge.

3. **Full management in popup**: All tag additions/removals happen in the popup. The preview is read-only.

4. **Real-time state**: Every interaction is immediately committed. No confirm/cancel pattern.

5. **Popup width**: Matches control width, with minimum 320px (mobile-friendly).

6. **Mobile layout**: Search input moves to BOTTOM of popup (thumb-reachable). CSS handles reordering via `order` or `flex-direction`. DOM structure remains the same.

7. **Mobile consideration**: Future enhancement could make popup full-screen on small viewports.

---

## Proposed placement in this repo
Implement as **core components** (consistent with `nui-input`, `nui-tabs`, etc.):

### nui-tag-input
- JS: `NUI/nui.js` (via `registerComponent('nui-tag-input', ...)`)
- CSS: `NUI/css/nui-theme.css` (new section for tag input)
- Playground page: `Playground/pages/components/tag-input.html`

### nui-select
- JS: `NUI/nui.js` (via `registerComponent('nui-select', ...)`)
- CSS: `NUI/css/nui-theme.css` (in the form input components section)
- Playground page: `Playground/pages/components/select.html`
- Wire into navigation: `Playground/js/main.js` (under **Components**)

Notes:
- No separate module import required (Playground already imports `NUI/nui.js`).
- No extra CSS link required (styles live in `nui-theme.css`).

---

## 1) nui-tag-input Component (Standalone)

A reusable tag management component that can be used independently or composed by `nui-select`.

### Use Cases
- Multi-select tag display (inside `nui-select` popup)
- Filter/keyword input fields
- Email recipient inputs
- Any "list of removable items" UI

### Authoring Pattern

```html
<!-- Standalone usage -->
<nui-tag-input name="keywords">
	<!-- Optional: pre-populated via hidden inputs -->
	<input type="hidden" name="keywords" value="javascript">
	<input type="hidden" name="keywords" value="typescript">
</nui-tag-input>

<!-- With visible input for adding tags -->
<nui-tag-input name="filters" editable>
	<!-- User can type to add new tags -->
</nui-tag-input>
```

### Form Compatibility
Internally uses hidden `<input>` elements for form submission:
```html
<nui-tag-input name="keywords">
	<!-- Generated by component -->
	<input type="hidden" name="keywords" value="javascript">
	<input type="hidden" name="keywords" value="typescript">
	
	<!-- Visual tag elements -->
	<div class="nui-tag-input-tags">
		<span class="nui-tag">
			<span class="nui-tag-text">javascript</span>
			<button type="button" class="nui-tag-remove" aria-label="Remove javascript">Ã—</button>
		</span>
		...
	</div>
</nui-tag-input>
```

### DOM Structure
```html
<nui-tag-input name="keywords" class="has-tags">
	<!-- Hidden inputs for form submission (one per tag) -->
	<input type="hidden" name="keywords" value="javascript">
	<input type="hidden" name="keywords" value="typescript">
	
	<!-- Tags container -->
	<div class="nui-tag-input-tags" role="list">
		<span class="nui-tag" role="listitem" data-value="javascript">
			<span class="nui-tag-text">javascript</span>
			<button type="button" 
				class="nui-tag-remove" 
				aria-label="Remove javascript"
				tabindex="-1">Ã—</button>
		</span>
		<span class="nui-tag" role="listitem" data-value="typescript">
			<span class="nui-tag-text">typescript</span>
			<button type="button" 
				class="nui-tag-remove" 
				aria-label="Remove typescript"
				tabindex="-1">Ã—</button>
		</span>
	</div>
	
	<!-- Optional: text input for adding tags (when editable) -->
	<input type="text" class="nui-tag-input-field" placeholder="Add tag...">
</nui-tag-input>
```

### Public API

#### Attributes
| Attribute | Type | Description |
|-----------|------|-------------|
| `name` | string | Form field name for hidden inputs |
| `editable` | boolean | Shows text input for adding tags |
| `placeholder` | string | Placeholder for the text input (when editable) |

#### Methods
| Method | Returns | Description |
|--------|---------|-------------|
| `addTag(value, label?)` | boolean | Adds a tag. Returns false if duplicate. Label defaults to value. |
| `removeTag(value)` | boolean | Removes tag by value. Returns false if not found. |
| `hasTag(value)` | boolean | Checks if tag exists |
| `listTags()` | Array<{value, label}> | Returns all tags |
| `clear()` | void | Removes all tags |
| `getValues()` | string[] | Returns array of tag values |

#### Events
| Event | Detail | Description |
|-------|--------|-------------|
| `nui-tag-add` | `{ value, label }` | Fired when tag is added |
| `nui-tag-remove` | `{ value, label }` | Fired when tag is removed |
| `nui-change` | `{ values, tags }` | Fired on any change (add or remove) |

### Accessibility
- Container has `role="list"`
- Tags have `role="listitem"`
- Remove buttons have `aria-label="Remove {tagName}"`
- Remove buttons have `tabindex="-1"` (not in tab order)
- When `editable`: Backspace on empty input removes last tag
- Live region announces changes: "javascript added", "typescript removed"

### CSS Classes
| Class | Element | Description |
|-------|---------|-------------|
| `nui-tag-input` | root | Component root |
| `.nui-tag-input-tags` | container | Tags container |
| `.nui-tag` | tag | Individual tag wrapper |
| `.nui-tag-text` | span | Tag label text |
| `.nui-tag-remove` | button | Remove button (Ã—) |
| `.nui-tag-input-field` | input | Text input for adding (when editable) |
| `.has-tags` | root | State: has at least one tag |
| `.is-empty` | root | State: no tags |

---

## 2) Feature Parity Scope (nui-select)

### In scope (v1):
- `searchable` attribute enables filter input with "No results" message
- Multi-select with tags + remove affordance (keyboard accessible)
- Disabled options respected (skipped in keyboard nav, visually muted)
- Disabled select (entire control non-interactive)
- Required select (validation integration with `nui-input-group`)
- Optgroups rendered as logical visual groupings
- Events on selection changes (native `change` + `nui-change`)

### Non-goals (future):
- Async remote search / AJAX loading
- Virtualized rendering for 1000+ options
- Complex typeahead modes beyond substring match

---

## 2) Semantic HTML Baseline (DOM-first)

### Recommended authoring pattern:

```html
<nui-input-group>
	<label>Country</label>
	<nui-select searchable>
		<select name="country" required>
			<option value="">Select a countryâ€¦</option>
			<option value="no">Norway</option>
			<option value="se">Sweden</option>
		</select>
	</nui-select>
</nui-input-group>
```

### Behavior:
- **Without JS:** The native `<select>` is visible and functions normally.
- **With JS:** Upgrade hides the `<select>` visually (but keeps it in DOM for form submission) and renders the enhanced UI.

### Placeholder convention:
- An `<option value="">` is treated as a placeholder (not a real selection).
- Alternatively, `<option disabled selected hidden>` works (standard HTML5 pattern).
- The `placeholder` attribute on `<nui-select>` provides fallback text if no placeholder option exists.

---

## 3) Accessibility Approach (ARIA Pattern)

Follow the **W3C APG Combobox with Listbox Popup** pattern.

### Control element:
- **Searchable:** `<input type="text">` with `role="combobox"`
- **Non-searchable:** `<button type="button">` with `role="combobox"`
  - Button is semantically correct, naturally focusable, and activates on Enter/Space

Both variants have:
```
role="combobox"
aria-expanded="true|false"
aria-controls="<listbox-id>"
aria-haspopup="listbox"
aria-activedescendant="<active-option-id>"  (while popup is open)
```

### Popup listbox:
```
role="listbox"
id="<listbox-id>"
aria-multiselectable="true"  (only when <select multiple>)
```

### Options:
```
role="option"
id="<unique-option-id>"  (for aria-activedescendant)
aria-selected="true|false"
aria-disabled="true"  (when option is disabled)
```

### Option groups:
- Wrap grouped options in a container with `role="group"` and `aria-label="<optgroup label>"`
- Group headers are **presentation-only** (not focusable, not options)
- Keyboard navigation skips group headers

### Live region for announcements:
```html
<div aria-live="polite" aria-atomic="true" class="nui-select-status visually-hidden"></div>
```
Used for:
- "No results" when filter yields 0
- Result count updates (optional: "5 options available")

---

## 4) Public API + Events

### Configuration from native `<select>`:
- `multiple` â€” enables multi-select mode with tags
- `disabled` â€” disables entire control
- `required` â€” enables validation
- `name` â€” for form submission
- Options and optgroups parsed from children

### Attributes on `<nui-select>`:
| Attribute | Type | Description |
|-----------|------|-------------|
| `searchable` | boolean | Enables filter input |
| `placeholder` | string | Fallback placeholder text |

### Methods:
| Method | Description |
|--------|-------------|
| `open()` | Opens the popup |
| `close()` | Closes the popup |
| `refresh()` | Re-scans `<select>` children and rebuilds option cache |
| `validate()` | Runs validation, returns boolean, dispatches event |

### Events:
| Event | Target | Detail |
|-------|--------|--------|
| `change` | native `<select>` | Standard native event (for form compatibility) |
| `nui-change` | `<nui-select>` | `{ value, values, text, texts, name }` |
| `nui-open` | `<nui-select>` | `{}` |
| `nui-close` | `<nui-select>` | `{}` |
| `nui-validate` | `<nui-select>` | `{ valid, message }` |

---

## 6) DOM Structure + Element Reuse (Performance)

### Fixed-Size Control Pattern

The control element NEVER changes size based on selection. This prevents layout shifts.

**Closed state (preview):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
â”‚ [Norway] [Sweden] [Den~~~  (gradient)   â”‚ 5 â”‚ â–¼ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜
         â†‘ overflow:hidden + fade          â†‘ count
```

**Open state (popup):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
â”‚ [Norway] [Sweden] [Den~~~               â”‚ 5 â”‚ â–² â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”¤
â”‚ Full Tags (editable):                           â”‚
â”‚ [Norway Ã—] [Sweden Ã—] [Denmark Ã—] [Finland Ã—]   â”‚
â”‚ [Iceland Ã—]                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ” Search...                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â˜ Norway                                        â”‚
â”‚ â˜‘ Sweden          (scrollable list)             â”‚
â”‚ â˜ Denmark                                       â”‚
â”‚ ...                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Generated DOM structure:
```html
<nui-select class="is-open is-multi">
	<!-- Hidden native select (source of truth for form submission) -->
	<select name="country" multiple style="position:absolute;opacity:0;pointer-events:none;">
		<option value="no" selected>Norway</option>
		<option value="se" selected>Sweden</option>
		<option value="dk">Denmark</option>
		...
	</select>
	
	<!-- Control (FIXED SIZE - never expands) -->
	<button type="button" class="nui-select-control" role="combobox" 
		aria-expanded="false" aria-haspopup="listbox" aria-controls="popup-123">
		
		<!-- Preview: tag chips with overflow hidden -->
		<span class="nui-select-preview">
			<span class="nui-select-preview-tags">
				<span class="nui-tag nui-tag--readonly">Norway</span>
				<span class="nui-tag nui-tag--readonly">Sweden</span>
				<span class="nui-tag nui-tag--readonly">Denmark</span>
				<!-- more may be clipped -->
			</span>
			<span class="nui-select-preview-fade" aria-hidden="true"></span>
		</span>
		
		<!-- Count badge -->
		<span class="nui-select-count" aria-label="5 items selected">5</span>
		
		<!-- Dropdown arrow -->
		<span class="nui-select-arrow" aria-hidden="true"></span>
	</button>
	
	<!-- Popup (min-width: 320px, max-width: control width or larger) -->
	<div class="nui-select-popup" id="popup-123" hidden>
		
		<!-- Full editable tags (multi-select only) -->
		<div class="nui-select-popup-tags">
			<nui-tag-input>
				<!-- Managed by nui-select, synced with native select -->
			</nui-tag-input>
		</div>
		
		<!-- Search input (if searchable) -->
		<div class="nui-select-search">
			<input type="text" 
				placeholder="Search..." 
				aria-label="Filter options"
				autocomplete="off">
		</div>
		
		<!-- Options list -->
		<div class="nui-select-options" role="listbox" aria-multiselectable="true">
			<div class="nui-select-option is-selected" role="option" 
				id="opt-no" aria-selected="true" data-value="no">
				<span class="nui-select-option-check" aria-hidden="true">âœ“</span>
				<span class="nui-select-option-text">Norway</span>
			</div>
			<div class="nui-select-option is-selected" role="option" 
				id="opt-se" aria-selected="true" data-value="se">
				<span class="nui-select-option-check" aria-hidden="true">âœ“</span>
				<span class="nui-select-option-text">Sweden</span>
			</div>
			<div class="nui-select-option" role="option" 
				id="opt-dk" aria-selected="false" data-value="dk">
				<span class="nui-select-option-check" aria-hidden="true"></span>
				<span class="nui-select-option-text">Denmark</span>
			</div>
			
			<!-- Groups (if optgroups present) -->
			<div class="nui-select-group" role="group" aria-label="Baltic">
				<div class="nui-select-group-label" aria-hidden="true">Baltic</div>
				<div class="nui-select-option" role="option" ...>Estonia</div>
				<div class="nui-select-option" role="option" ...>Latvia</div>
			</div>
			
			<!-- No results message -->
			<div class="nui-select-no-results" hidden>No results found</div>
		</div>
	</div>
	
	<!-- Live region for screen reader announcements -->
	<div class="nui-select-live" aria-live="polite" aria-atomic="true"></div>
</nui-select>
```

### Single-select DOM (simpler):
```html
<nui-select class="is-single">
	<select name="country">...</select>
	
	<button type="button" class="nui-select-control" role="combobox" ...>
		<span class="nui-select-value">Norway</span>
		<span class="nui-select-arrow" aria-hidden="true"></span>
	</button>
	
	<div class="nui-select-popup" hidden>
		<!-- No tags section for single-select -->
		<div class="nui-select-search">...</div>
		<div class="nui-select-options" role="listbox">
			<!-- Options without checkmarks -->
		</div>
	</div>
</nui-select>
```

### Element reuse strategy:
- **Control, popup, search input, live region:** Created once in `connectedCallback`
- **Option rows:** Cached via `WeakMap(nativeOption â†’ optionRowEl)`
- **Preview tags:** Cloned from internal `nui-tag-input` on each render (cheap, small number)
- **Popup tags:** Uses composed `nui-tag-input` component (manages its own cache)
- **Filtering:** Toggles `hidden` attribute on existing option rows (no DOM rebuild)

### Two-way sync (multi-select):
1. **Option click** â†’ toggle `<option selected>` â†’ update `nui-tag-input` â†’ update preview
2. **Tag remove (Ã—)** â†’ remove from `nui-tag-input` â†’ deselect `<option>` â†’ update preview
3. **Native select** always reflects true state (for form submission)

---

## 6) Keyboard + Focus Model

### Focus management lifecycle:

| Event | Focus behavior |
|-------|----------------|
| **Open (searchable)** | Move focus to search input |
| **Open (non-searchable)** | Keep focus on control button, use `aria-activedescendant` |
| **Navigate options** | Update `aria-activedescendant`, scroll option into view |
| **Close** | Return focus to control (button or input) |
| **Tab out** | Close popup, allow natural tab navigation |

### Keyboard shortcuts (popup closed):
| Key | Action |
|-----|--------|
| `Enter`, `Space` | Open popup |
| `ArrowDown` | Open popup and activate first option |
| `ArrowUp` | Open popup and activate last option |

### Keyboard shortcuts (popup open):
| Key | Action |
|-----|--------|
| `ArrowDown` | Move to next visible, enabled option |
| `ArrowUp` | Move to previous visible, enabled option |
| `Home` | Move to first visible, enabled option |
| `End` | Move to last visible, enabled option |
| `Enter` | Select active option (single: close; multi: toggle, stay open) |
| `Space` | Select active option (same as Enter) â€” unless searchable (types space) |
| `Escape` | Close popup, return focus to control |
| `Tab` | Close popup, move focus to next focusable element |

### Active option highlighting:
- Only one option is "active" at a time (keyboard highlight)
- Active option has `.is-active` class and is referenced by `aria-activedescendant`
- Selected options have `.is-selected` class and `aria-selected="true"`
- These are independent states (active â‰  selected)

---

## 7) Multi-Select: Tag Integration

In multi-select mode, `nui-select` composes `nui-tag-input` for tag management.

### Architecture
- **Popup tags section**: Contains a `nui-tag-input` instance (editable)
- **Preview tags**: Read-only clones shown in the control (overflow hidden)
- **Native select**: Always the source of truth for form submission

### Two-way sync flow:
```
User clicks option â†’ 
  toggle option.selected â†’
  call tagInput.addTag() or removeTag() â†’
  update preview tags â†’
  dispatch nui-change

User clicks tag Ã— â†’
  tagInput.removeTag() â†’
  deselect native option â†’
  update preview tags â†’
  dispatch nui-change
```

### Tag accessibility (delegated to nui-tag-input):
- Tags have `role="listitem"` within `role="list"` container
- Remove buttons have `aria-label="Remove {tagName}"`
- Remove buttons have `tabindex="-1"` (click/touch only in v1)
- `Backspace` on empty search input removes last tag

### Screen reader announcements:
- On selection: "Norway added. 3 items selected."
- On deselection: "Norway removed. 2 items selected."
- Announcements via live region in `nui-select`

---

## 8) Search/Filter Behavior

Enabled by `searchable` attribute.

### Filter logic:
- Case-insensitive substring match against option text
- Disabled options are shown but remain non-selectable
- Empty placeholder options are excluded from results

### Filter updates:
- Debounce input by ~100ms to avoid excessive updates
- Toggle `hidden` attribute on option rows (don't rebuild DOM)
- Show/hide group headers based on whether any child options are visible

### No results state:
- Show `.nui-select-no-results` element
- Update live region: "No results found"
- Keyboard navigation has no options to move through

### On close:
- Clear search input text
- Reset filter (show all options)

---

## 9) Disabled + Required State Handling

### Disabled select (`<select disabled>`):
- Add `.is-disabled` class to `<nui-select>`
- Set `aria-disabled="true"` on control
- Control is not focusable (`tabindex="-1"`)
- Popup cannot be opened
- Visual styling: reduced opacity, no hover effects

### Disabled options (`<option disabled>`):
- Option row has `.is-disabled` class and `aria-disabled="true"`
- Skipped during keyboard navigation
- Click does nothing
- Visual styling: muted text, no hover highlight

### Required select (`<select required>`):
- Works with `nui-input-group` validation display
- On blur or form submit, check `select.validity.valid`
- If invalid: add `.is-invalid` class, dispatch `nui-validate` event
- If valid: add `.is-valid` class (optional)
- Error message pattern follows `nui-input` (`.nui-error-message` element)

---

## 10) Open Direction (Popup Positioning)

### Logic:
1. Get control's bounding rect
2. Calculate available space below: `window.innerHeight - rect.bottom`
3. Calculate available space above: `rect.top`
4. Estimate popup height (use `max-height` or measure if already rendered)
5. If popup fits below â†’ open below (default)
6. If popup doesn't fit below but fits above â†’ open above
7. If neither fits â†’ open in direction with more space, enable scroll

### CSS classes:
- `.is-above` â€” popup opens upward
- `.is-below` â€” popup opens downward (default)

### Position updates:
- On open: calculate direction
- On window resize: recalculate if popup is open
- On scroll (if in scrollable container): consider recalculating or closing

---

## 11) Animation

Use CSS keyframe animations triggered via class toggle, following the pattern established for `nui-dialog`.

### CSS animations (adapt from legacy `nui_select.css`):
```css
@keyframes nui-select-open {
	from { opacity: 0; transform: scaleY(0); }
	to { opacity: 1; transform: scaleY(1); }
}

@keyframes nui-select-close {
	from { opacity: 1; transform: scaleY(1); }
	to { opacity: 0; transform: scaleY(0); }
}

.nui-select-popup {
	transform-origin: top center;
}

.nui-select-popup.is-above {
	transform-origin: bottom center;
}

.nui-select-popup.is-opening {
	animation: nui-select-open 0.1s ease-out forwards;
}

.nui-select-popup.is-closing {
	animation: nui-select-close 0.08s ease-in forwards;
}
```

### JS animation pattern:
```javascript
function openPopup(element) {
	popup.hidden = false;
	popup.classList.add('is-opening');
	popup.addEventListener('animationend', () => {
		popup.classList.remove('is-opening');
	}, { once: true });
}

function closePopup(element) {
	popup.classList.add('is-closing');
	popup.addEventListener('animationend', () => {
		popup.classList.remove('is-closing');
		popup.hidden = true;
	}, { once: true });
}
```

---

## 12) Styling + Theming

CSS goes in `NUI/css/nui-theme.css` in the form input components section.

### Use existing theme tokens:
- `--color-*`, `--border-*`, `--nui-space*`, `--border-radius*`, `--shadow-*`

### Visual targets (matching legacy):
- Control with dropdown arrow indicator
- Popup with max-height (~40vh) and scrollbar
- Selected option highlight (background color)
- Active option highlight (keyboard focus, different from selected)
- Tags with remove button (multi-select)
- Group headers (muted, non-interactive)
- Search input (if searchable)
- Disabled states (reduced opacity, no pointer events)

### CSS class reference:

#### nui-select classes:
| Class | Element | Purpose |
|-------|---------|---------|
| `nui-select` | root | Component root |
| `.is-single` | root | Single-select mode |
| `.is-multi` | root | Multi-select mode |
| `.is-open` | root | Popup is visible |
| `.is-disabled` | root | Disabled state |
| `.is-invalid` | root | Validation failed |
| `.is-valid` | root | Validation passed |
| `.nui-select-control` | button | Trigger button |
| `.nui-select-value` | span | Single-select value text |
| `.nui-select-preview` | span | Multi-select preview container |
| `.nui-select-preview-tags` | span | Preview tags (overflow hidden) |
| `.nui-select-preview-fade` | span | Gradient fade overlay |
| `.nui-select-count` | span | Selection count badge |
| `.nui-select-arrow` | span | Dropdown indicator |
| `.nui-select-popup` | div | Dropdown container |
| `.is-above` | popup | Opens upward |
| `.is-below` | popup | Opens downward (default) |
| `.is-opening` | popup | Open animation |
| `.is-closing` | popup | Close animation |
| `.nui-select-popup-tags` | div | Tags section in popup |
| `.nui-select-search` | div | Search input wrapper |
| `.nui-select-options` | div | Options list container |
| `.nui-select-option` | div | Option row |
| `.nui-select-option-check` | span | Checkmark (multi-select) |
| `.nui-select-option-text` | span | Option text |
| `.is-active` | option | Keyboard-highlighted |
| `.is-selected` | option | Currently selected |
| `.is-disabled` | option | Disabled option |
| `.nui-select-group` | div | Group container |
| `.nui-select-group-label` | div | Group header text |
| `.nui-select-no-results` | div | No results message |
| `.nui-select-live` | div | Live region (visually hidden) |

#### nui-tag / nui-tag-input classes:
| Class | Element | Purpose |
|-------|---------|---------|
| `nui-tag-input` | root | Tag input component root |
| `.has-tags` | root | Has at least one tag |
| `.is-empty` | root | No tags |
| `.nui-tag-input-tags` | div | Tags container |
| `.nui-tag-input-field` | input | Text input for adding (when editable) |
| `.nui-tag` | span | Individual tag |
| `.nui-tag--readonly` | tag | Non-interactive preview tag |
| `.nui-tag-text` | span | Tag label text |
| `.nui-tag-remove` | button | Remove button (Ã—) |

---

## 13) Playground Demos

### nui-tag-input demo page
Create `Playground/pages/components/tag-input.html` demonstrating:

1. **Basic tag input** (programmatic only)
2. **Editable tag input** (with text input for adding)
3. **Pre-populated tags** (via hidden inputs)
4. **API demo** (addTag, removeTag, listTags, clear)
5. **Events demo** (nui-tag-add, nui-tag-remove, nui-change)
6. **Form submission demo** (shows hidden inputs in form data)

### nui-select demo page
Create `Playground/pages/components/select.html` demonstrating:

1. **Basic single select** (non-searchable)
2. **Searchable single select**
3. **Multi-select with tags** (fixed-size control, full tags in popup)
4. **Optgroups**
5. **Disabled options**
6. **Disabled select**
7. **Required select with validation** (in `nui-input-group`)
8. **Keyboard interaction demo** (callout with instructions)

Wire both into:
- `Playground/js/main.js` navigation (under Components section)

---

## 14) Testing Checklist

### nui-tag-input testing:

#### Programmatic API:
- [ ] `addTag('value')` adds tag, returns true
- [ ] `addTag('value')` with duplicate returns false
- [ ] `addTag('value', 'Label')` uses custom label
- [ ] `removeTag('value')` removes tag, returns true
- [ ] `removeTag('nonexistent')` returns false
- [ ] `hasTag('value')` returns correct boolean
- [ ] `listTags()` returns array of {value, label}
- [ ] `getValues()` returns array of values
- [ ] `clear()` removes all tags

#### Events:
- [ ] `nui-tag-add` fires with {value, label}
- [ ] `nui-tag-remove` fires with {value, label}
- [ ] `nui-change` fires on add or remove

#### Form compatibility:
- [ ] Hidden inputs created for each tag
- [ ] Form submission includes all tag values
- [ ] Hidden inputs use correct `name` attribute

#### Editable mode:
- [ ] Text input visible when `editable` attribute present
- [ ] Enter adds tag from input value
- [ ] Input clears after adding
- [ ] Backspace on empty input removes last tag
- [ ] Duplicate value prevented (no duplicate tags)

#### Accessibility:
- [ ] Container has `role="list"`
- [ ] Tags have `role="listitem"`
- [ ] Remove buttons have `aria-label`

---

### nui-select testing:

#### Keyboard-only:
- [ ] Can Tab to the control
- [ ] Can open with Enter/Space/ArrowDown
- [ ] Can navigate options with ArrowUp/ArrowDown
- [ ] Can select with Enter
- [ ] Can close with Escape
- [ ] Can Tab out (closes popup, moves focus)
- [ ] Home/End jump to first/last option
- [ ] Disabled options are skipped
- [ ] Multi: can toggle multiple selections
- [ ] Multi: Backspace removes last tag (if searchable)

#### Screen reader (NVDA/VoiceOver):
- [ ] Control announced as "combobox, collapsed"
- [ ] On open: "combobox, expanded"
- [ ] Options announced with name and selected state
- [ ] Active option announced on arrow navigation
- [ ] Multi: selection count announced
- [ ] No results announced via live region

#### Behavior:
- [ ] Outside click closes popup
- [ ] Opens downward by default
- [ ] Opens upward when near bottom of viewport
- [ ] Popup width >= 320px (min-width)
- [ ] Search filters options correctly
- [ ] Search clears on close
- [ ] Form submission includes selected value(s)
- [ ] Disabled select is non-interactive
- [ ] Required select shows validation error

#### Multi-select specific:
- [ ] Control shows preview tags with overflow hidden
- [ ] Count badge shows selection count
- [ ] Popup shows full editable tags
- [ ] Tag removal updates option selection
- [ ] Option deselection removes tag
- [ ] Preview updates after popup closes

#### Edge cases:
- [ ] Empty select (no options)
- [ ] All options disabled
- [ ] Very long option text (truncation)
- [ ] Select inside a scrollable container
- [ ] Rapid open/close (animation interruption)
- [ ] Dynamic option changes (call `refresh()`)

---

## 15) Implementation Notes

### Implementation order:
1. **nui-tag-input first** â€” standalone, no dependencies
2. **nui-select second** â€” composes nui-tag-input

### nui-tag-input implementation:
```javascript
registerComponent('nui-tag-input', (element) => {
	// Parse existing hidden inputs for initial tags
	const name = element.getAttribute('name');
	const isEditable = element.hasAttribute('editable');
	
	// Build UI
	setupTagInputUI(element, name, isEditable);
	
	// Public methods
	element.addTag = (value, label) => addTag(element, value, label);
	element.removeTag = (value) => removeTag(element, value);
	element.hasTag = (value) => hasTag(element, value);
	element.listTags = () => listTags(element);
	element.getValues = () => getValues(element);
	element.clear = () => clearTags(element);
});
```

### nui-select implementation:
```javascript
registerComponent('nui-select', (element) => {
	const select = element.querySelector('select');
	if (!select) return;
	
	const isMulti = select.multiple;
	const isSearchable = element.hasAttribute('searchable');
	
	// Setup functions
	setupSelectUI(element, select, isMulti, isSearchable);
	setupKeyboard(element);
	setupOutsideClick(element);
	
	if (isMulti) {
		// Create internal nui-tag-input for popup
		setupTagSync(element, select);
	}
	
	// Public methods
	element.open = () => openPopup(element);
	element.close = () => closePopup(element);
	element.refresh = () => rebuildOptions(element, select);
	element.validate = () => validateSelect(element, select);
});
```

### WeakMap caches (module scope):
```javascript
const optionRowCache = new WeakMap();  // <option> â†’ row element
const tagElCache = new WeakMap();      // <option> â†’ tag element (for preview)
```

This ensures DOM elements are garbage collected when options are removed.

### Styling considerations for implementer:
The DOM structure exposes clear class names for every element. Key styling hooks:

1. **Fixed-size control**: `.nui-select-control` needs fixed height, `overflow: hidden`
2. **Preview fade**: `.nui-select-preview-fade` is an overlay with gradient mask
3. **Count badge**: `.nui-select-count` positioned near arrow
4. **Popup positioning**: `.is-above` / `.is-below` for transform-origin
5. **Min-width enforcement**: `.nui-select-popup { min-width: 320px; }`
6. **Tag styles**: Shared between `nui-tag-input` and preview (`.nui-tag` class)

The JS implementation will:
- Add/remove state classes (`.is-open`, `.is-multi`, `.is-active`, etc.)
- Set inline styles only for dynamic positioning (popup top/bottom offset)
- Leave all visual styling to CSS
